Dashboard untitled_3 {
  title: 'Test Avg'
  description: ''''''

  view: CanvasLayout {
    label: 'View 1'
    width: 1380
    grid_size: 5
    block v1 {
      position: pos(20, 200, 660, 980)
      layer: 1
    }
    block v2 {
      position: pos(700, 200, 660, 980)
      layer: 1
    }
    block t1 {
      position: pos(70, 10, 360, 145)
    }
    block t2 {
      position: pos(450, 10, 380, 145)
      layer: 1
    }
    block t3 {
      position: pos(855, 10, 500, 145)
      layer: 1
    }
  }
  theme: H.themes.classic
  block v1: VizBlock {
    label: 'Users and average by month'
    viz: PivotTable {
      dataset: raw_aql_ecommerce
      calculation avg_orders {
        label: 'Avg Orders'
        formula: @aql unique(users.full_name) | average(count(orders.id)) ;;
        calc_type: 'measure'
        data_type: 'number'
      }
      calculation avg_orders_all_users {
        label: 'Avg Orders All Users'
        formula: @aql avg_orders | of_all(users.full_name);;
        calc_type: 'measure'
        data_type: 'number'
      }
      filter {
        field: ref('orders', 'created_at')
        operator: 'matches'
        value: '2021'
      }
      rows: [
        VizFieldFull {
          ref: ref('orders', 'created_at')
          transformation: 'datetrunc month'
          format {
            type: 'date'
            pattern: 'LLL yyyy'
          }
        },
        VizFieldFull {
          ref: ref('users', 'full_name')
          format {
            type: 'text'
          }
        }
      ]
      values: [
        VizFieldFull {
          ref: ref('orders', 'id')
          aggregation: 'count'
          format {
            type: 'number'
            pattern: 'inherited'
          }
          uname: 'count_id'
        },
        VizFieldFull {
          ref: 'avg_orders'
          format {
            type: 'number'
            pattern: 'inherited'
          }
          uname: 'custom_avg_orders'
        },
        VizFieldFull {
          ref: 'avg_orders_all_users'
          format {
            type: 'number'
            pattern: 'inherited'
          }
        }
      ]
      settings {
        pagination_size: 50
        row_limit: 10000
        column_width {
          manual_widths: [
            ColumnWidth {
              key: 'count_id'
              width: 102
            },
            ColumnWidth {
              key: 'custom_avg_orders'
              width: 105
            }
          ]
        }
        aggregate_awareness {
          enabled: true
          debug_comments: true
        }
        frozen_columns: 0
      }
    }
  }
  block v2: VizBlock {
    label: 'Count greater than average'
    viz: PivotTable {
      dataset: raw_aql_ecommerce
      calculation avg_orders {
        label: 'Avg Orders'
        formula: @aql unique(users.full_name) | average(count(orders.id)) ;;
        calc_type: 'measure'
        data_type: 'number'
      }
      calculation avg_orders_all_users {
        label: 'Avg Orders All Users'
        formula: @aql avg_orders | of_all(users.full_name);;
        calc_type: 'measure'
        data_type: 'number'
      }
      calculation greater_than_average {
        label: 'Greater Than Average'
        formula: @aql unique(users.full_name)
| filter(
  count(orders.id) > (avg_orders | of_all(users.full_name))
)
| count();;
        calc_type: 'measure'
        data_type: 'number'
      }
      filter {
        field: ref('orders', 'created_at')
        operator: 'matches'
        value: '2021'
      }
      rows: [
        VizFieldFull {
          ref: ref('orders', 'created_at')
          transformation: 'datetrunc month'
          format {
            type: 'date'
            pattern: 'LLL yyyy'
          }
        }
      ]
      values: [
        VizFieldFull {
          ref: ref('orders', 'id')
          aggregation: 'count'
          format {
            type: 'number'
            pattern: 'inherited'
          }
          uname: 'count_id'
        },
        VizFieldFull {
          ref: 'avg_orders_all_users'
          format {
            type: 'number'
            pattern: 'inherited'
          }
        },
        VizFieldFull {
          ref: 'greater_than_average'
          format {
            type: 'number'
            pattern: 'inherited'
          }
        }
      ]
      settings {
        pagination_size: 50
        row_limit: 10000
        column_width {
          manual_widths: [
            ColumnWidth {
              key: '48897e4e-7d2e-46d6-8bde-4d76befe7251'
              width: 105
            },
            ColumnWidth {
              key: 'count_id'
              width: 102
            }
          ]
        }
        aggregate_awareness {
          enabled: true
          debug_comments: true
        }
        frozen_columns: 0
      }
    }
  }
  block t1: TextBlock {
    content: @md ```
avg_orders = users 
| group(users.name) 
| select(count(orders.id))
| avg()
```;;
  }
  block t2: TextBlock {
    content: @md ```
avg_orders_of_all_users = avg_orders 
| of_all(users.name)
```;;
  }
  block t3: TextBlock {
    content: @md ```
Greater than average = avg_orders 
| group(users.name)
| filter(count(orders.id) > avg_orders_of_all_users)
| count()
```;;
  }
}